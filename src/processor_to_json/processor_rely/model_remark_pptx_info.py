# 使用大模型提取备注字段信息

from random import choice
import os
import dashscope

dash_keys = [
   os.getenv("DASHSCOPE_API_KEY1"),
   os.getenv("DASHSCOPE_API_KEY2"),
   os.getenv("DASHSCOPE_API_KEY3"), 
]

def extract_remark_info(text:str) -> dict:
    """
    使用大模型提取备注字段信息。

    参数:
        text (str): 包含供应商相关信息的字符串。

    返回:
        dict: 提取到的备注字段信息，格式为字典。如果未提取到信息则返回空字典。
    """


    messages=[
            {'role': 'system', 'content': 'You are a helpful assistant.'},
            {'role': 'user', 'content': 
             f"""
                # 任务说明
                请从以下供应商介绍文本中，精准提取指定关键信息，并以标准 JSON 字典格式返回。仅提取明确提及的信息，不推测、不补全、不合并。

                # 提取字段定义（严格按以下规则执行）
                1. "联系方式"：
                - 仅提取**完整的工厂物理地址**，且必须包含至少：省份 + 城市 + 区/县（或镇/街道）。
                - 示例有效地址："江苏省扬州市仪征市月塘镇工业区"
                - 无效地址（不提取）：仅“江苏”、“扬州”、“华东地区”等范围过大或模糊地址。
                - 提取后统一添加前缀“地址：”，格式为："地址：xxx"。
                - 若无符合要求的地址，则该字段值为空字符串 ""。

                2. "主销市场"：
                - 提取所有提及的**销售国家、地区、城市**，以及**外贸占比、出口比例**等数据。
                - 包含如：“欧美市场”、“美国占比70%”、“外贸占比90%”、“主要出口日本”等。
                - 保留原始表述，可适当统一标点使其通顺（如分号分隔）。
                - 不包含“国内市场”、“本地销售”等非出口信息，除非特别说明为主销。
                - 若无相关信息，则该字段值为空字符串 ""。

                3. "验厂/认证"：
                - 提取所有明确列出的**认证名称**，如：BSCI、SA8000、ISO9001、FDA、CE、SEDEX 等。
                - 仅提取认证名称，不带前缀如“通过”、“已获”等。
                - 多个认证用分号分隔，如："BSCI; ISO9001; CE"
                - 若无认证提及，则该字段值为空字符串 ""。

                4. "合作情况"：
                - 仅提取明确提到的**合作客户名称或公司名称**，如：“与沃尔玛长期合作” → 提取“沃尔玛”。
                - 仅提取**具体客户名**，不提取“多家世界500强企业”、“知名品牌”等模糊描述。
                - 多个客户用分号分隔，如："沃尔玛; 宜家; 苹果"
                - 若无具体客户名称，则该字段值为空字符串 ""。

                5. "是否供样"：
                - 判断是否提及“可提供样品”、“免费供样”等表述。
                - 若有，则值为 "是"；若明确说“不供样”或“收费供样”，则为 "否"。
                - 若未提及，则为 ""（空字符串）。

                6. "备注"：
                - 将原文中**未被提取到上述五个字段中的其余所有内容**，按原始顺序拼接成一段文本。
                - 不增删内容，仅增删标点，微调以保证语句的通顺和用户阅读。
                - 若所有内容均被提取，则备注为空字符串 ""。

                # 工作流程（严格执行）
                1. 逐句扫描输入文本。
                2. 对每句话判断是否属于上述五个字段之一。
                3. 若属于，提取并归入对应字段（仅提取，不改写原意）。
                4. 剩余未被提取的内容，按顺序拼接填入“备注”字段。
                5. 所有字段必须存在，即使为空。

                # 输出格式要求
                - 仅输出一个标准 Python 字典（JSON-like），不包含任何额外说明、注释或标记。
                - 不使用 ```json 或其他代码块包裹。
                - 所有字段的值必须为**单行纯文本**，禁止使用换行符（\n）、回车符（\r）或任何形式的软换行。
                - 字段内容中不得出现回车、缩进、段落分隔，所有信息必须在同一物理行内呈现。
                - 字段名严格按照以下顺序和拼写：
                {{
                    "联系方式": "...",
                    "主销市场": "...",
                    "验厂/认证": "...",
                    "合作情况": "...",
                    "是否供样": "...",
                    "备注": "..."
                }}

                # 示例
                文本内容：
                “公司是一家专注于硅藻土日用产品的研发，生产和销售。拥有160多名员工，月生产能力达到30万件，年出口达到780个集装箱。外贸占比:90%，主营市场：美国占比70%，欧洲占比20%，日本占比5%。工厂有自营出口。工厂面积：16000㎡。年产值：5000-6000万RMB”

                输出：
                {{
                    "联系方式": "",
                    "主销市场": "外贸占比:90%；美国占比70%，欧洲占比20%，日本占比5%",
                    "验厂/认证": "",
                    "合作情况": "",
                    "是否供样": "",
                    "备注": "公司是一家专注于硅藻土日用产品的研发，生产和销售。拥有160多名员工，月生产能力达到30万件，年出口达到780个集装箱。工厂有自营出口。工厂面积：16000㎡。年产值：5000-6000万RMB"
                }}



                # 重要注意事项
                1. 不推测：如“通过国际认证”但未列名称 → “验厂/认证”为空。
                2. 不提取模糊客户：“与多家国际品牌合作” → “合作情况”为空。
                3. 地址必须完整：仅有“江苏扬州” → 不提取，“联系方式”为空。
                4. 保留原文信息顺序，仅做标点优化。
                5. 每个字段独立判断，互不干扰。

                # 待处理文本
                {text}
                """
            }
        ]
    response = dashscope.Generation.call(
    api_key=choice(dash_keys),
    model="qwen-plus", 
    messages=messages,
    result_format='message',
    response_format={"type": "text"}
    )

    return response.output.choices[0].message.content if response and response.output else {}

   
if __name__ == "__main__":
    text = "外贸占比：90% 主营市场：中东100% 工厂面积：300亩 年  产  值：20亿人民币 员工人数：300人  位于济南市市中区京岚线的工业园区 工厂面积：浙江本部占地10000 建筑，1.6万㎡ 山东4000㎡年产值：4000万RMB"
    print(extract_remark_info(text))